<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
  <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
  <title></title>
  <link rel="stylesheet" href="../../../assets/css/api.css"/>
  <link rel="stylesheet" href="../../../assets/css/style.css">
  <link rel="stylesheet" href="../../../assets/iconfont/iconfont.css">
  <style>
    #app {
      background: #f0f0f0;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: #f0f0f0;
    }

    #app {
      height: 100%;
    }

    .headerbox {
      width: 100%;
      height: auto;
      box-sizing: border-box;
      background: white;
    }

    .headerimg {
      width: 90%;
      height: 100%;
    }

    .tokenmessage {
      width: 85%;
      height: 3rem;
      margin: auto;
      line-height: 3rem;
      background: white;
      border-bottom: 1px solid gainsboro;
      font-size: 15px;
    }

    .tokendetails {
      width: 85%;
      background: white;
      height: auto;
      margin: auto;
      border-bottom: 1px solid gainsboro;
      font-size: 14px;
      display: flex;
      padding-top: 20px;
      padding-bottom: 5px;
    }

    .detailsbox {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
    }

    .detailsbox img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }

    .ifont {
      position: absolute;
      bottom: -5%;
      z-index: 10;
      left: 50%;
      margin-left: -1rem;
      width: 2rem;
      background: orangered;
      color: white;
      font-size: 10px;
      text-align: center;
    }

    .rightboxs {
      flex: 1;
    }

    .nametime {
      line-height: 2rem;
      display: flex;
    }

    .nametime span {
      flex: 1;
      font-size: 13px;
    }

    .artical {
      width: 100%;
      font-size: 13px;
      word-break: break-all;
    }

    .ixin {
      color: #f44336;
    }

    .findmore {
      width: 85%;
      margin: auto;
      height: 2rem;
      text-align: center;
      line-height: 2rem;
      font-size: 14px;
    }

    .fixedbox {
      width: 100%;
      height: 44px;
      background: white;
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 1000;
      display: flex;
    }

    .fixedbox span {
      width: 44px;
      font-size: 15px;
      text-align: center;
    }

    .oinput {
      height: 1.6rem;
      font-size: 14px;
      border-radius: 5px;
      margin: auto;
      width: 60%;
      line-height: 1.6rem;
      color: darkgray;
    }

    .icontype {
      margin: auto;
      font-size: 15px;
      flex: 1;
      text-align: center;
    }

    .lefttitle {
      margin-left: 15px;
      font-size: 13px;
      float: left;
      line-height: 2rem;
    }

    .righttitle {
      float: right;
      margin-right: 15px;
      font-size: 13px;
      line-height: 2rem;
    }

    .contentbox {
      height: auto;
      margin-bottom: 5px;
      word-break: break-all;
      padding-left: 15px;
      padding-right: 15px;
      box-sizing: border-box;
      font-size: 15px;
    }

    .contentbox * {
      max-width: 95%;
    }

    .contentnum {
      float: right;
      margin-right: 10px;
      font-size: 13px;
    }

    .contentnumbox {
      width: 100%;
      height: 2rem;
    }

    .contentbox img {
      max-width: 95%;
    }

      /*分享*/
    .bottompoup {
      width: 100%;
      height: 12rem;
      background: white;
    }

    .fourkind {
      width: 100%;
      height: auto;
      display: flex;
      flex-direction: row;
    }

    .minkind {
      flex: 1;
      text-align: center;
    }

    .publicfont {
      font-size: 50px;
    }

    .minkind p {
      font-size: 14px;
    }

    .sharetitle {
      line-height: 2.5rem;
      font-size: 15px;
    }

    .canclebox {
      width: 100%;
      height: 5rem;
      display: flex;
    }

    .cancelinput {
      width: 70%;
      height: 2rem;
      line-height: 2rem;
      border-radius: 20px;
      border: 1px solid #9f9f9f;
      text-align: center;
      font-size: 14px;
      margin: auto;
    }
  </style>
</head>
<body>
<div id='app'>
  <div id="loadStart"></div>
  <div class="headerbox">
    <p style="line-height:2rem;text-align: center">{{mycontlist.title}}</p>
    <span class="lefttitle">{{mycontlist.editTime}}</span>
    <span class="righttitle">{{mycontlist.author}}</span>
    <div style="display: inline-block;width: 100%;height: 30%;text-align: center">
      <img class="headerimg" :src="formatImg(mycontlist.cover)">
    </div>

    <div class="contentbox" v-html="count"></div>
    <div class="contentnumbox"><span class="contentnum">阅读 {{mycontlist.conuter}}</span></div>
  </div>

  <div style="width: 100%;height: 1rem;background: #f0f0f0"></div>
  <div style="width: 100%;height: auto;background: white">
    <div class="tokenmessage">
      <span><i class="iconfont icon-liuyan"></i></span><span style="margin-left: 0.5rem">全部留言（{{alltoken.count || '0'}}）</span>
    </div>

    <div class="tokendetails" v-for="(item,index) in tokenlist">
      <div class="detailsbox" style="position: relative">
        <img :src="formatImg(item.avatar)">
        <div class="ifont" v-if="item.isQinAuth==1||item.isUserAuth==1">V认证</div>
      </div>
      <div class="rightboxs">
        <div class="nametime">
          <span style="margin-left: 0.2rem;font-size: 16px">{{item.nickname}}<i style="color:#ffbb28" class="iconfont icon-huangguan-copy" v-if="item.level==1"></i></span>
          <span style="text-align: right;margin-right: 0.2rem;color:#b8b8b8">{{item.addTime}}</span>
        </div>
        <div class="artical">
          {{item.content}}
        </div>
        <div style="width: 100%;line-height: 2rem;text-align: right;margin-right: 20px">
                <span>
                    <i v-if="item.ifAgree==1" class="iconfont ixin icon-xin" @click="culEvaluateDoAgree(index)"></i>
                    <i v-else class="iconfont icon-ziyuan8" @click="culEvaluateDoAgree(index)"></i>
                    {{item.countAgree}}
                </span>
        </div>
      </div>

    </div>
    <div class="findmore" @click="checkmore()">
      查看更多
    </div>
    <div style="width: 100%;line-height:2rem;background: #f0f0f0;text-align: center;font-size: 14px">——END——</div>
    <div style="width: 100%;height: 44px"></div>
    <div class="fixedbox">
        <span @click="culDoAgree(1)">
             <i v-if="agree==1" class="iconfont ixin icon-xin"></i>
             <i v-else class="iconfont icon-ziyuan8"></i>
            <p>{{agreenum}}</p>
        </span>

      <span @click="culDoAgree(2)">
            <i v-if="collect==1" style="color: #fcbd54" class="iconfont ixin icon-shoucang"></i>
            <i v-else class="iconfont icon-shoucang1"></i>
            <p>{{countnum}}</p>
            </span>
      <div class="oinput" style="background:#e5e5e5" @click="sendtoken()">
        我要留言
      </div>
      <span style="line-height: 44px"><i class="iconfont icontype icon-liuyan"></i></span>
    </div>
  </div>


  <mt-popup class="bottompoup"
            v-model="bler"
            position="bottom">

    <p class="sharetitle"><span style="margin-left: 10px">分享到</span></p>
    <div class="fourkind">
      <div class="minkind" @click="shareto(1)">
        <i style="color: #20cb33" class="iconfont publicfont icon-weixin-copy"></i>
        <p>微信好友</p>
      </div>

      <div class="minkind" @click="shareto(2)">
        <i style="color: #20cb33" class="iconfont publicfont icon-pengyouquan"></i>
        <p>朋友圈</p>
      </div>
      <div class="minkind" @click="shareto(3)">
        <i style="color: #24bbff" class="iconfont publicfont icon-qq"></i>
        <p>QQ</p>
      </div>
      <div class="minkind" @click="shareto(4)">
        <i style="color: #f7c000" class="iconfont publicfont icon-qqkongjian"></i>
        <p>QQ空间</p>
      </div>

    </div>
    <div class="canclebox">
      <mt-button class="cancelinput" @click="falsebtn()">取消</mt-button>
    </div>
  </mt-popup>


</div>
</body>
</html>
<script type="text/javascript" src="../../../assets/js/public.js"></script>
<script type="text/javascript" src="../../../assets/js/api.js"></script>
<script type="text/javascript" src="../../../assets/iconfont/iconfont.js"></script>
<script type="text/javascript" src="../../../assets/js/fastclick.js"></script>
<script>
  new FastClick(document.body);
</script>
<script type="text/javascript" src="../../../assets/js/vue.min.js"></script>
<script type="text/javascript" src="../../../assets/js/vue-resource.js"></script>
<script type="text/javascript" src="../../../assets/js/index.js"></script>
<script type="text/javascript">
  var app = new Vue({
    el: '#app',
    data: {
      articleid: '',
      cateid: '',
      tokenlist: [],
      relust: [],
      tokennum: '',
      mycontlist: [],
      collect: '',
      agree: '',
      agreenum: '',
      alltoken: [],
      count: '',
      countnum: '',
      bookcount: '',
      // 分享
      bler: false,
      sharename: '',
      sharecount: '',
      shareimg: ''
    },
    filters: {},
    created: function () {
      apiready = function () {
        refresh(function () {
          app.culGetEvaluateList(app.articleid,function () {
            refreshDone();
          });
        });

        app.articleid = api.pageParam.articleid;
        app.cateid = api.pageParam.cateid;
        app.culGetEvaluateList(app.articleid, function () {
          app.getCulDetails(app.articleid, function () {
            loadEnd();
          });
        });

        api.addEventListener({
          name: 'shuaxinmessage'
        }, function (ret, err) {
          app.page = 1;
          app.culGetEvaluateList(app.articleid, 1);
        });

        // 分享
        api.addEventListener({
          name: 'sendshare'
        }, function (ret, err) {
          app.bler = true
        });
      };
    },
    methods: {
      // 分享
      shareto: function (ind) {
        var wx = api.require('wx');
        var qq = api.require('QQPlus');
        app.bler = false;
        switch (ind) {
          case 1 : {
            wx.shareWebpage({
              apiKey: '',
              scene: 'session',
              title: app.sharename,
              description: app.sharecount,
              thumb: formatShareImg(app.shareimg),
              contentUrl: wapUrl +'wap/html2/tool/book/details_fm.html?' + app.cateid + ',' + app.articleid
//              contentUrl: wapUrl + 'wap/html2/download/download.html?2'
            }, function (ret, err) {
              if (ret.status) {
                api.toast({
                  msg: '分享成功！'
                });
              } else {
                if (err.code == 2) {
                  api.toast({
                    msg: '取消分享'
                  });
                } else {
                  qpi.toast({
                    msg: '分享失败'
                  })
                }
              }
            });
            break;
          }
          case 2 : {
            wx.shareWebpage({
              apiKey: '',
              scene: 'timeline',
              title: app.sharename,
              description: app.sharecount,
              thumb: formatShareImg(app.shareimg),
              contentUrl: wapUrl +'wap/html2/tool/book/details_fm.html?' + app.cateid + ',' + app.articleid
//              contentUrl: wapUrl + 'wap/html2/download/download.html?2'
            }, function (ret, err) {
              if (ret.status) {
                toastMsg('分享成功');
              } else {
                toastMsg('取消分享');
              }
            });
            break;
          }
          case 3 : {
            qq.shareNews({
              url: wapUrl +'wap/html2/tool/book/details_fm.html?' + app.cateid + ',' + app.articleid,
//              url: wapUrl + 'wap/html2/download/download.html?2',
              title: app.sharename,
              description: app.sharecount,
              imgUrl: formatShareImg(app.shareimg),
              type: 'QFriend'
            }, function (ret, err) {
            });

            break;
          }
          case 4 : {
            qq.shareNews({
              url: wapUrl +'wap/html2/tool/book/details_fm.html?' + app.cateid + ',' + app.articleid,
//              url: wapUrl + 'wap/html2/download/download.html?2',
              title: app.sharename,
              description: app.sharecount,
              imgUrl: formatShareImg(app.shareimg),
              type: 'QZone'
            }, function (ret, err) {
            });
            break;
          }
        }
      },
      falsebtn: function () {
        app.bler = false;
      },

      change: function (index) {
        app.changeindex = index
      },
//            查看全部留言
      checkmore: function () {
        api.openWin({
          name: 'tokenmessage_win',
          url: '../tokenmessage/tokenmessage_win.html',
          pageParam: {
            articleid: app.articleid
          }
        });
      },
//            留言底下那三个
      culGetEvaluateList: function (articleid,callback) {
        var post = {
          cmd: 'culGetEvaluateList',
          articleId: articleid,
          token: getToken()
        };
        sendAjax(this, post, function (res) {
          if(callback){
            callback()
          }

          app.alltoken = res.data;
          app.tokenlist = res.data.proList.slice(0, 3);
          app.bookcount = charToHtml(res.data.proList.content);
          app.tokennum = res.data.count;
          for (var i = 0; i < app.tokenlist.length; i++) {
            app.tokenlist[i].addTime = app.tokenlist[i].addTime.substring(0, 10);
          }
        });
      },
//            我评论的的收藏和支持,以及详情简介内容
      getCulDetails: function (articleid, callback) {
        var post = {
          cmd: 'getCulDetails',
          articleId: articleid,
          cate: app.cateid,
          token: getToken()
        };

        sendAjax(this, post, function (res) {
          app.mycontlist = res.data.proList;
          app.count = charToHtml(app.mycontlist.content);
          app.collect = res.data.proList.ifCollect;
          app.agree = res.data.proList.ifAgree;
          app.agreenum = res.data.proList.countAgree;
          app.countnum = res.data.proList.countCollect;

//                    分享内容
          app.sharename = res.data.proList.title;
          app.sharecount = '古琴工具书';
          app.shareimg = res.data.proList.cover;

          if (callback) {
            callback();
          }
        });
      },
//            底部的我要留言 跳转到留言板
      sendtoken: function () {
        openView('sendmessage_fm', 'tools/tokenmessage/sendmessage_fm', '留言板', false, false, {
          articleId: app.articleid
        })
      },
//            支持网友留言/取消支持
      culEvaluateDoAgree: function (index) {
        if (getToken() != null) {
          if (app.tokenlist[index].ifAgree == 1) {
            app.tokenlist[index].ifAgree = 0;
            app.tokenlist[index].countAgree--
          } else {
            app.tokenlist[index].ifAgree = 1;
            app.tokenlist[index].countAgree++
          }
        }
        var post = {
          cmd: 'culEvaluateDoAgree',
          commentId: app.tokenlist[index].commentId,
          token: getToken()
        };
        sendAjax(this, post, function (res) {
        })
      },
//            支持/取消 我的 收藏或支持
      culDoAgree: function (num) {

        if (num == 2 && getToken() != null) {
          if (app.collect == 1) {
            app.collect = 0;
            app.countnum--
          } else {
            app.collect = 1;
            app.countnum++
          }
        }
        if (num == 1 && getToken() != null) {
          if (app.agree == 1) {
            app.agree = 0;
            app.agreenum--
          } else {
            app.agree = 1;
            app.agreenum++
          }
        }

        var post = {
          cmd: 'culDoAgree',
          articleId: app.articleid,
          agreeOrCollect: num,
          token: getToken()
        };
        sendAjax(this, post, function (res) {

        })
      }
    }
  })
</script>