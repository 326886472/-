<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
  <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
  <title></title>
  <link rel="stylesheet" href="../../../assets/css/api.css"/>
  <link rel="stylesheet" href="../../../assets/css/style.css">
  <link rel="stylesheet" href="../../../assets/iconfont/iconfont.css">
  <style>
    #app {
      background: white;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: #f0f0f0;
    }

    #app {
      height: auto;
    }

    .tokenmessage {
      width: 85%;
      height: 3rem;
      margin: auto;
      line-height: 3rem;
      background: white;
      border-bottom: 1px solid gainsboro;
      font-size: 15px;
    }

    .tokendetails {
      width: 85%;
      height: auto;
      margin: auto;
      border-bottom: 1px solid gainsboro;
      font-size: 14px;
      display: flex;
      padding-top: 20px;
      padding-bottom: 5px;
    }

    .detailsbox {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
    }

    .detailsbox img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }

    .ifont {
      position: absolute;
      bottom: -5%;
      z-index: 10;
      left: 50%;
      margin-left: -1rem;
      width: 2rem;
      background: orangered;
      color: white;
      font-size: 10px;
      text-align: center;
    }

    .rightbox {
      flex: 1;
    }

    .nametime {
      line-height: 2rem;
      display: flex;
    }

    .nametime span {
      flex: 1;
      font-size: 13px;
    }

    .artical {
      width: 100%;
      font-size: 13px;
      word-break: break-all;
    }

    .ixin {
      color: #f44336;
    }

    .findmore {
      width: 85%;
      margin: auto;
      text-align: center;
      line-height: 2rem;
      font-size: 14px;
    }

    .fixedbox {
      width: 100%;
      height: 44px;
      background: white;
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 1000;
      display: flex;
    }

    .fixedbox span {
      width: 44px;
      font-size: 15px;
      text-align: center;
    }

    .oinput {
      height: 1.6rem;
      font-size: 14px;
      border-radius: 5px;
      margin: auto;
      width: 60%;
    }

    .headerbox {
      width: 100%;
      height: auto;
      padding: 10px;
      box-sizing: border-box;
    }

    .titlename {
      line-height: 2rem;
      font-size: 17px;
      font-weight: bold;
    }

    .teachname {
      font-size: 14px;
      line-height: 1.5rem;
    }

    .tioicont {
      margin-left: 10px;
      color: gainsboro;
    }

    .contfont {
      font-size: 13px;
      line-height: 2rem;
    }

    .imgbox {
      width: 100%;
      height: 60%;
      margin-top: 0.5rem;
    }

    .imgbox img {
      width: 100%;
      height: 100%;
    }

    .callback {
      width: 100%;
      height: auto;
      background: #f0f0f0;
      padding: 5px;
      box-sizing: border-box;
      color: #7b7b7b;
    }

    .lookmore {
      width: 100%;
      margin-top: 0.5rem;
      height: 2rem;
      background: #f0f0f0;
      text-align: center;
      line-height: 2rem;
    }

    .namemessage {
      line-height: 1.5rem;
      font-size: 12px;
      color: #7b7b7b;
    }

    .tokenspan {
      text-align: right;
      margin-right: 0.5rem;
      color: #7b7b7b;
    }

    .icontype {
      margin: auto;
      flex: 1;
      text-align: center;
      font-size: 20px
    }

    .musicbox {
      width: 100%;
      height: 10rem
    }

    .playmusic {
      width: 100%;
      height: 100%;
    }

    .pablsulote {
      position: fixed;
      top: 30px;
      left: 10px;
    }

    .bottomdiv {
      width: 100%;
      height: 2rem;
      text-align: center;
      line-height: 2rem;
      background: #f0f0f0;
      color: black;
    }

    .uptext {
      color: #bfbfbf;
      font-size: 13px;
    }

    .publicfont {
      width: 20px;
      height: 20px;
      margin: auto;
    }

  </style>
</head>
<body>
<div id='app'>
  <div id="loadStart"></div>
  <i class="iconfont pablsulote icon-ziyuan2-copy"></i>
  <div class="musicbox">

    <!--<video class="playmusic" src="../../../assets/images/one.mov" controls poster="../../../assets/images/tanqin.png">-->
    <!--</video>-->


  </div>
  <div class="headerbox">

    <p class="titlename">{{musicdetailslist.title}}</p>
    <p class="teachname">{{musicdetailslist.author}}</p>
    <div style="font-size: 14px">{{musicdetailslist.desc}}</div>
    <div class="contfont">
            <span @click="culDoAgree(1)">
                <i v-if="agree==1" style="color: #f44336" class="iconfont tioicont icon-xin"></i>
                 <i v-else class="iconfont tioicont icon-ziyuan8"></i>
                <sapn>{{musicdetailslist.countAgree}}</sapn>
            </span>

      <span @click="culDoAgree(2)" style="margin-left: 10px">

                <i v-if="collect==1" style="color: #fcbd54" class="iconfont ixin icon-shoucang"></i>
                <i v-else class="iconfont icon-shoucang1"></i>
                <sapn>{{musicdetailslist.countCollect}}</sapn>
            </span>

    </div>
  </div>

  <div style="width: 100%;height: 1rem;background: #f0f0f0"></div>

  <div class="tokenmessage">
    <span><i class="iconfont icon-liuyan"></i></span><span style="margin-left: 0.5rem">全部留言（{{count || '0'}}）</span>
  </div>

  <div class="tokendetails" v-for="(item,index) in tokenlist">
    <div class="detailsbox" style="position: relative;flex-shrink: 0">
      <img :src="formatImg(item.avatar)">
      <div class="ifont" v-if="item.isQinAuth==1||item.isUserAuth==1">V认证</div>
    </div>
    <div class="rightbox">
      <div class="nametime">
        <span style="margin-left: 0.2rem">{{item.nickname}}<i style="color:#ffbb28" class="iconfont icon-huangguan-copy"
                                                              v-if="item.level==1"></i></span>
        <span style="text-align: right;margin-right: 0.2rem">{{item.addTime}}</span>
      </div>
      <div class="artical">
        {{item.content}}
      </div>
      <div style="width: 100%;line-height: 2rem;text-align: right;margin-right: 20px">
                <span>
                     <i v-if="item.ifAgree==1" class="iconfont ixin icon-xin" @click="culEvaluateDoAgree(index)"></i>
                     <i v-else class="iconfont icon-ziyuan8" @click="culEvaluateDoAgree(index)"></i>
                    {{item.countAgree}}
                </span>
        <span>
                    <i class="iconfont ixin icon-liuyan"></i>
                    {{item.countReply}}
                </span>
      </div>
      <div style="width: 100%">
        <div class="callback" v-for="(replyItem,index) in item.reply" v-if="index<app.labellength">
          <p class="namemessage">
            <span>{{replyItem.nickname}}</span>
            <span style="color:#f46c5a">回复:@{{item.nickname}}</span>
          </p>
          <div style="width: 100%;height: auto">
            <p>{{replyItem.content}}</p>
            <p class="tokenspan"><i class="iconfont icon-xiaoxi"></i></p>
          </div>
        </div>
        <div v-if="item.reply.length>2" class="lookmore" @click="checkallmessage(index)">查看全部（{{item.countReply}}）</div>
      </div>
    </div>

  </div>

  <div class="bottomdiv">
    <span v-if="rote" class="uptext">---上拉加载---</span>
    <img v-if="load" class="publicfont" src="../../../assets/images/timg.gif">
    <span v-if="overlate" class="uptext">数据已全部加载</span>
  </div>


</div>
</body>
</html>
<script type="text/javascript" src="../../../assets/js/public.js"></script>
<script type="text/javascript" src="../../../assets/js/api.js"></script>
<script type="text/javascript" src="../../../assets/iconfont/iconfont.js"></script>
<script type="text/javascript" src="../../../assets/js/fastclick.js"></script>
<script>
  new FastClick(document.body);
</script>
<script type="text/javascript" src="../../../assets/js/vue.min.js"></script>
<script type="text/javascript" src="../../../assets/js/vue-resource.js"></script>
<script type="text/javascript" src="../../../assets/js/index.js"></script>
<script type="text/javascript">
  var app = new Vue({
    el: '#app',
    data: {
      articleid: '',
      cateid: '',
      tokenlist: [],
      labellength: 2,
      count: 0,
      musicdetailslist: [],
      videocountnum: '',
      countnum: 0,
      agree: '',
      collect: '',
      content: '',
      //      下来加载的页数和有多少个
      page: 1,
      perPage: 5,
      //      判断 状态 圈，上拉加载，已经加载全部
      rote: false,
      overlate: false,
      load: false
    },
    filters: {},
    watch: {
      'countnum': function (value) {
        if (value == 2) {
          loadEnd()
        }
      }
    },
    created: function () {
      apiready = function () {
        app.articleid = api.pageParam.articleid;
        app.cateid = api.pageParam.cateid;
        //        第一次加载数据
        app.culGetEvaluateList(app.articleid, 1);


        app.culGetEvaluateList(app.articleid);
        app.getCulDetails(app.articleid);
        api.addEventListener({
          name: 'shuaxinmessage'
        }, function (ret, err) {
          app.page = 1;
          app.culGetEvaluateList(app.articleid, 1);
        });

        //      监听事件滑动

        api.addEventListener({
          name: 'scrolltobottom',
          extra: {
            threshold: 40 //设置距离底部多少距离时触发，默认值为0，数字类型
          }
//                滑动时候改变的值
        }, function (ret, err) {
          app.load = true;//加载的圈
          app.rote = false;//上拉加载的文字
          app.overlate = false;//显示全部的文字
          app.page++;
          app.culGetEvaluateList(app.articleid);
        });
      };
    },
    methods: {
      change: function (index) {
        app.changeindex = index
      },

//            我评论的的收藏和支持状态,以及详情简介内容
      getCulDetails: function (articleid) {
        var post = {
          cmd: 'getCulDetails',
          articleId: articleid,
          cate: app.cateid,
          token: getToken
        };
        sendAjax(this, post, function (res) {
          app.musicdetailslist = res.data.proList;
          app.videocountnum = charToHtml(res.data.proList.content);
          app.collect = res.data.proList.ifCollect;
          app.agree = res.data.proList.ifAgree;
          app.agreenum = res.data.proList.countAgree;
          app.countCollect = res.data.proList.countCollect;
          app.labr()
        });
      },

//            留言下面的全部+更多+商家回复
      culGetEvaluateList: function (articleid, ref) {
        var post = {
          cmd: 'culGetEvaluateList',
          articleId: articleid,
          token: getToken(),
          page: app.page,
          perPage: app.perPage
        };
        sendAjax(this, post, function (res) {
          if (ref == 1) {
            app.tokenlist = res.data.proList;
            app.count = res.data.count ? res.data.count : 0;
            app.rote = true;
            app.load = false
          } else {
            app.tokenlist = app.tokenlist.concat(res.data.proList);
            app.rote = true;
            app.load = false
          }
          if (res.data.proList.length == 0) {
            app.overlate = true;
            app.rote = false;
            app.load = false
          }

          for (var k = 0; k < res.data.proList.length; k++) {
            res.data.proList[k].reply = [];
          }
          app.labr();

          for (var i = 0; i < app.tokenlist.length; i++) {
            console.log(app.tokenlist[i].addTime.substring(0, 10));
            app.tokenlist[i].addTime = app.tokenlist[i].addTime.substring(0, 10);
          }

          app.getReplyEvaluateList();

        });
      },
//             支持网友留言/取消支持
      culEvaluateDoAgree: function (index) {
        if (getToken() != null) {
          if (app.tokenlist[index].ifAgree == 1) {
            app.tokenlist[index].ifAgree = 0;
            app.tokenlist[index].countAgree--;
          } else {
            app.tokenlist[index].ifAgree = 1;
            app.tokenlist[index].countAgree++
          }
        }

        var post = {
          cmd: 'culEvaluateDoAgree',
          commentId: app.tokenlist[index].commentId,
          token: getToken
        };
        sendAjax(this, post, function (res) {

        })
      },
//            回复评论

      getReplyEvaluateList: function () {
        for (var j = 0; j < app.tokenlist.length; j++) {
          app.culGetReplyEvaluateList(app.tokenlist[j].commentId, j);
        }

      },
      culGetReplyEvaluateList: function (commentId, index) {
        var post = {
          cmd: 'culGetReplyEvaluateList',
          commentId: commentId
        };
        sendAjax(this, post, function (res) {
          app.tokenlist[index].reply = res.data.proList;
          app.labr()
        });
      },

//            查看所有回复
      checkallmessage: function (index) {
        app.labellength = app.tokenlist[index].reply.length
      },
//            支持/取消 我的 收藏或支持
      culDoAgree: function (num) {

        if (num == 2 && getToken() != null) {
          if (app.collect == 1) {
            app.collect = 0;
            app.musicdetailslist.countCollect--;
          } else {
            app.collect = 1;
            app.musicdetailslist.countCollect++
          }
        }

        if (num == 1 && getToken() != null) {
          if (app.agree == 1) {
            app.agree = 0;
            app.musicdetailslist.countAgree--;
          } else {
            app.agree = 1;
            app.musicdetailslist.countAgree++
          }
        }

        var post = {
          cmd: 'culDoAgree',
          articleId: app.articleid,
          agreeOrCollect: num,
          token: getToken
        };
        sendAjax(this, post, function (res) {
        })
      },
      labr: function () {
        app.countnum++
      }

    }
  })
</script>











